{#<!--
Gibbon: the flexible, open school platform
Founded by Ross Parker at ICHK Secondary. Built by Ross Parker, Sandra Kuipers and the Gibbon community (https://gibbonedu.org/about/)
Copyright © 2010, Gibbon Foundation
Gibbon™, Gibbon Education Ltd. (Hong Kong)

This is a Gibbon template file, written in HTML and Twig syntax.
For info about editing, see: https://twig.symfony.com/doc/2.x/
-->#}

{% set standardLayout = "noIntBorder" not in form.getClass and "form-small" not in form.getClass and "blank" not in form.getClass %}
{% set smallLayout = "form-small" in form.getClass %}
{% set useSections = "noIntBorder" not in form.getClass and "blank" not in form.getClass %}
{% set useSaveWarning = "noIntBorder" not in form.getClass and "disable-warnings" not in form.getClass %}
{% set isToolBoxForm = "toolbox-form" in form.getClass %}

{% if quickSave and form.getAction %}
    <form x-validate {{ form.getAttributeString|raw }} hx-trigger="quicksave, keydown[metaKey&&key=='s'] from:body" hx-post="{{ form.getAction }}" hx-target=".formStatusReturn" hx-select="#alerts" hx-swap="innerHTML show:none swap:0.5s" hx-disinherit="*" hx-vals='{"HX-QuickSave": true}' x-data="{'show': true, 'saving': false, 'invalid': false, 'submitting': false, 'showTimeout': false}" x-on:htmx:before-request="if ($event.detail.requestConfig.elt.nodeName == 'FORM') { saving = true; show = true;  clearTimeout(showTimeout); }" x-on:htmx:after-swap="saving = false" x-on:htmx:after-settle="showTimeout = setTimeout(() => show = false, 5000); $dispatch('saved');" x-ref="form" @submit="$validate.submit; invalid = !$validate.isComplete($el); if (invalid) submitting = false;" @change.debounce.750ms="if (invalid) invalid = !$validate.isComplete($el); ">

    <div class="formStatus fixed bottom-0 right-4 z-50" x-cloak>
        <div class="formIndicator magic drop-shadow-md" x-show="saving" >{{ __('Saving') }} ...</div>
        <div class="formStatusReturn drop-shadow-md" x-show="!saving && show" ></div>
    </div>
{% elseif form.getAction != 'ajax' %}
    <form x-validate {{ form.getAttributeString|raw }} x-data="{'advancedOptions': {{ form.getData('advanced-options')|default('false') }}, 'invalid': false, 'submitting': false}"  x-ref="form" @submit="$validate.submit; invalid = !$validate.isComplete($el); if (invalid) submitting = false;" @change.debounce.750ms="if (invalid) invalid = !$validate.isComplete($el); ">
{% endif %}

    {% if form.hasPages %}
        <ul class="multiPartForm my-6">
            {% for page in form.getPages %}
            <li class="step {{ page.number <= form.getCurrentPage ? 'active' : '' }}">
                {% if page.url and page.number <= form.getMaxPage and page.number != form.getCurrentPage %}
                    <a href="{{ page.url }}" class="-mt-10 pt-10 text-gray-800 hover:text-purple-600 hover:underline">
                {% endif %}
                {{- page.name -}}
                {% if page.url and page.number <= form.getMaxPage and page.number != form.getCurrentPage %}
                    </a>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    {% endif %}

    {% if form.getTitle and not form.getHeader %}
        <h2 class="text-4xl font-bold text-gray-900 mb-2">{{ form.getTitle }}</h2>
    {% endif %}

    {% if form.getDescription %}
        <p class="text-lg text-gray-600 mb-8">{{ form.getDescription|raw }}</p>
    {% endif %}

    {% if introduction %}
        <p class="text-lg text-gray-600 mb-8">{{ introduction|raw }}</p>
    {% endif %}

    {% block header %}
        <header class="relative print:hidden flex justify-between items-end mb-8 {{ standardLayout ? '' }}">
            {% if form.getHeader %}
                <h2 class="text-4xl font-bold text-gray-900">{{ form.getTitle }}</h2>
                <div class="linkTop flex justify-end gap-2 h-10 py-px">
                    {% for action in form.getHeader %}
                        {{ action.getOutput|raw }}
                    {% endfor %}
                </div>
            {% endif %}
        </header>
    {% endblock header %}

    {% for values in form.getHiddenValues %}
        <input type="hidden" name="{{ values.name }}" value="{{ values.value }}">
    {% endfor %}

    {% if form.getRows|length > 0 %}
        {% if isToolBoxForm %}
            <!-- ToolBox Modern Layout: Response 2/3, Form 1/3 -->
            <div class="max-w-7xl mx-auto">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Form takes 1/3 of the space -->
                    <div class="lg:col-span-1">
                        <div id="form" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 space-y-4 toolbox-form" 
                            {% if useSaveWarning %}
                            x-data="{changed: false, 
                                checkInput(formElement) {  
                                    document.getElementById(formElement.id).addEventListener('input', (evt) => {
                                        this.changed = true;
                                        window.onbeforeunload = function(event) {
                                            if (event.target.activeElement.nodeName == 'INPUT' || event.target.activeElement.type=='submit' || event.target.activeElement.classList.contains('submit-button')) return;
                                            return Gibbon.config.htmx.unload_confirm;
                                        };
                                    });
                                },
                                afterSave() {
                                    this.changed = false;
                                    window.onbeforeunload = null;
                                },
                            }" x-init="checkInput($el)" @saved.window="afterSave()"
                            {% endif %}
                            >

                            {% for section, rows in form.getRowsByHeading %}
                                {% set sectionLoop = loop %}

                                {% if useSections and section != 'submit' %}
                                <section class="space-y-4">
                                {% endif %}

                                {% for num, row in rows %}
                                    {% set rowLoop = loop %}

                                    {% if section == 'submit' %}
                                        <div class="pt-4">
                                            {% for element in row.getElements %}
                                                {% if element.getAttribute('type') == 'submit' %}
                                                    <button type="submit" 
                                                           name="{{ element.getAttribute('name') }}" 
                                                           value="{{ element.getAttribute('value') }}" 
                                                           class="w-full cta-gradient text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 flex items-center justify-center space-x-2">
                                                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.236 4.53L8.107 10.5a.75.75 0 00-1.214 1.029l1.5 2.25a.75.75 0 001.214 0l3.75-5.25z" clip-rule="evenodd" />
                                                        </svg>
                                                        <span>{{ element.getValue ?: __('Submit') }}</span>
                                                    </button>
                                                {% else %}
                                                    {{ element.getOutput|raw }}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <div id="{{ row.getID }}" class="space-y-2 {{ row.getClass }}" {{ row.getAttributeString('', 'id,class')|raw }}>
                                            {% for element in row.getElements %}
                                                {% if element.isInstanceOf('Gibbon\\Forms\\Layout\\Heading') %}
                                                    <h3 class="text-xl font-bold text-gray-900 mb-3">{{ element.getOutput|raw }}</h3>
                                                {% elseif element.isInstanceOf('Gibbon\\Forms\\Layout\\Label') %}
                                                    <label class="block text-sm font-semibold text-gray-900 mb-2">{{ element.getOutput|raw }}</label>
                                                {% else %}
                                                    <div class="modern-input-wrapper">
                                                        {{ element.getOutput|raw }}
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                {% endfor %}

                                {% if useSections and section != 'submit' %}
                                </section>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Response area takes 2/3 of the space -->
                    <div class="lg:col-span-2">
                        <div id="toolbox-response-area" class="min-h-96">
                            <!-- Response content will be displayed here after form submission -->
                            <div class="bg-gray-50 rounded-lg p-8 h-full flex items-center justify-center">
                                <div class="text-center text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                    </svg>
                                    <h3 class="text-lg font-medium text-gray-700 mb-2">Ready to Generate</h3>
                                    <p class="text-sm text-gray-500">Fill out the form and click "Generate Resource" to create your educational material.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Regular Full-Screen Form Layout -->
            <div id="form" class="{{ form.getClass }}">
                {% for section, rows in form.getRowsByHeading %}
                    {% if useSections and section != 'submit' %}
                    <section>
                        {% if section %}
                            <h3>{{ section }}</h3>
                        {% endif %}
                    {% endif %}

                    {% for num, row in rows %}
                        <div id="{{ row.getID }}" class="{{ row.getClass }}" {{ row.getAttributeString('', 'id,class')|raw }}>
                            {% for element in row.getElements %}
                                {{ element.getOutput|raw }}
                            {% endfor %}
                        </div>
                    {% endfor %}

                    {% if useSections and section != 'submit' %}
                    </section>
                    {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    {% endif %}

    {% if postScript %}
    <p>{{ postScript|raw }}</p>
    {% endif %}

    <script type="text/javascript">
        {% if quickSave and form.getAction %}
        $(document).keydown(function(event) {
            if (!((String.fromCharCode(event.which).toLowerCase() == 's' || event.keyCode == 13) && event.metaKey) && !(event.which == 19)) return true;
            event.preventDefault();
            return false;
        });
        {% endif %}

        {% for code in javascript %}
            {{ code|raw }}
        {% endfor %}
    </script>

{% if form.getAction != 'ajax' %}
</form>
{% endif %}